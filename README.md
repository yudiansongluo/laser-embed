# laser-embebed

[ProjectConverter](https://github.com/phodina/ProjectConverter) is used to convert

This project is an example of conversion from [Keil Embedded Development Tools for Arm](https://www.keil.com/) to [CMake](https://cmake.org/).

## Usage

### Preparation

- CMake
- [GNU Arm Embedded Toolchain](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads)
- [MSYS2](https://www.msys2.org/) (If you're running on Windows)
- [stlink-org/stlink](https://github.com/stlink-org/stlink/releases/tag/v1.7.0) (add it to you `PATH`)

### Modify `CMakeLists.txt`

#### Windows

modify the `tools` varible to your location of GNU Arm Embeded Toolchain

```cmake
set(tools "C:/Program Files (x86)/GNU Arm Embedded Toolchain/9 2020-q2-update")
```

and use (you should choose [MSYS Makefiles](https://cmake.org/cmake/help/latest/generator/MSYS%20Makefiles.html) or [MinGW Makefiles](https://cmake.org/cmake/help/latest/generator/MinGW%20Makefiles.html) as your generator)

```powershell
cmake . -G "MSYS Makefiles"
```

to generate your makefile.

#### Linux

Just

```bash
cmake .
```

directly, you don't have to configure anything else (I guess)

### Configuration of Visual Studio Code

modify your `c_cpp_properties.json`. You have to configure C/C++ extension properly to make IntelliSense work correctly.

```jsonc
{
    "configurations": [
        {
            "name": "STM32F10X", // Just name it
            "includePath": [
                "${workspaceFolder}/**", // include all the files in workspace
                // This is where you install your GNU Arm Embedded Toolchain. 
                "C:\\Program Files (x86)\\GNU Arm Embedded Toolchain\\9 2020-q2-update\\arm-none-eabi\\include\\**"  
            ],
            "defines": [
                "_DEBUG",
                "UNICODE",
                "_UNICODE",
                "STM32F10X_HD", // This is additional defines
                "USE_STDPERIPH_DRIVER" // This is additional defines
            ],
            // You MUST set your compilerPath to GNU Arm Embedded Toolchain or it will complain
            "compilerPath": "C:\\Program Files (x86)\\GNU Arm Embedded Toolchain\\9 2020-q2-update\\bin\\arm-none-eabi-gcc.exe",
            "cStandard": "c17",
            "cppStandard": "c++17",
            "intelliSenseMode": "${default}", // I have no idea what this means so just default
            "compileCommands": "${workspaceFolder}/build/compile_commands.json",
            "configurationProvider": "ms-vscode.cmake-tools" // I have no idea what this means. Maybe it's about cmake
        }
    ],
    "version": 4
}
```

See [µVision User's Guide Preprocessor Symbols](https://www.keil.com/support/man/docs/uv4/uv4_dg_adscc.htm)

### Use Keil as Command Line Tools

See [µVision User's Guide: Command Line](https://www.keil.com/support/man/docs/uv4/uv4_commandline.htm). Also check this gist: [Makefile for building keil projects](https://gist.github.com/samvasko/10017340).

#### ARM Compiler

- [embedded - Which one is better, gcc or armcc for NEON optimizations? - Stack Overflow](https://stackoverflow.com/questions/12577572/which-one-is-better-gcc-or-armcc-for-neon-optimizations)
- [[CMake] Correct way to use ARMCC (Files in Modules/Compiler/ARMCC*)](https://cmake.org/pipermail/cmake/2016-September/064261.html)
- [Compiler User Guide: ARM Compiler v5.06 for µVision armcc User Guide](https://www.keil.com/support/man/docs/armcc/)
- [Arm Compiler | Arm Compiler 6 Downloads – Arm Developer](https://developer.arm.com/tools-and-software/embedded/arm-compiler/downloads/version-6)

### Encoding from GBK to UTF-8

If you are using keil, I'm sure your file encoding is GBK. You'd better convert to UTF-8 first.

```bash
# convert all the Chinese encoding to UTF-8 for C and C++ source files
# You have to install enca
# https://github.com/nijel/enca
# and libenca
# https://packages.ubuntu.com/focal/libdevel/libenca-dev

find ./ -name "*.c" -o -name "*.cpp" -o -name "*.h" -type f | xargs enca -L chinese -x utf-8
```

## Useful Links

### CMake

- [visual c++ - Automatically add all files in a folder to a target using CMake? - Stack Overflow](https://stackoverflow.com/questions/3201154/automatically-add-all-files-in-a-folder-to-a-target-using-cmake)

### Project Generator

- [project-generator/project_generator: Project generators for various embedded tools (IDE). IAR, uVision, Makefile, CoIDE, Eclipse and many more in the roadmap!](https://github.com/project-generator/project_generator)
- [makefile generated by projectgenerator](https://gist.github.com/crosstyan/058c6be881ba1f51912a58fa146f232b)

### How the conversion works

- [Linux下实现飞控开发：使用CMake构建STM32工程_王伟韵-CSDN博客_cmake stm32](https://blog.csdn.net/loveuav/article/details/101361408)
- [根据Keil项目文件修改成tiny的Makefile_YearIllusion的博客-CSDN博客](https://blog.csdn.net/YearIllusion/article/details/102415237?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-4.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-4.control)
- [使用makefile替换Keil进行编译_zfx277266940的专栏-CSDN博客](https://blog.csdn.net/zfx277266940/article/details/39269045)
- [使用GCC编译STM32工程 | 码农家园](https://www.codenong.com/cs106677907/)
- [STM32 CMake 模板 | St.Lee的个人站](https://www.stlee.tech/2021/01/23/STM32-CMakeLists-txt-%E6%A8%A1%E6%9D%BF/)
- [cmake构建stm32工程 |](https://zhen8838.github.io/2018/08/14/cmakestm32/)
- [STM32 & Clion - 台部落](https://www.twblogs.net/a/5b8cf6a02b7177188337a978)

### Start up code and linker script

- [µVision User's Guide: Configure Startup Code](https://www.keil.com/support/man/docs/uv4/uv4_ca_config_start_code.htm)
- [startup files in Keil - Keil forum - Software Tools - Arm Community](https://community.arm.com/developer/tools-software/tools/f/keil-forum/29985/startup-files-in-keil)
- [From makefile to Cmake - stm32 - Stack Overflow](https://stackoverflow.com/questions/57348819/from-makefile-to-cmake-stm32)
- [“Bare Metal” STM32 Programming (Part 2): Making it to ‘Main’ – Vivonomicon's Blog](https://vivonomicon.com/2018/04/20/bare-metal-stm32-programming-part-2-making-it-to-main/)
- [From Zero to main(): Demystifying Firmware Linker Scripts | Interrupt](https://interrupt.memfault.com/blog/how-to-write-linker-scripts-for-firmware)
- [GNU LD 手冊略讀 (0): 目錄和簡介 - My code works, I don’t know why.](http://wen00072.github.io/blog/2014/12/14/study-on-the-linker-script-0-table-of-contents/)
- [gcc - why need linker script and startup code? - Stack Overflow](https://stackoverflow.com/questions/41365110/why-need-linker-script-and-startup-code)
